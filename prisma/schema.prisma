generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// UTILISATEURS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String?
  steamId       String?   @unique
  steamUsername String?
  avatarUrl     String?

  // Steam Match History (pour récupération automatique des démos)
  matchHistoryAuthCode String?   // Code d'auth fourni par CS2 pour accéder à l'historique
  lastKnownMatchCode   String?   // Dernier match share code connu (pour pagination)
  lastMatchSync        DateTime? // Dernière synchronisation des matchs

  // Rôle système et abonnement
  systemRole        SystemRole       @default(USER)
  subscriptionTier  SubscriptionTier @default(FREE)
  subscriptionExpiresAt DateTime?    // null = pas d'expiration (FREE ou lifetime)
  stripeCustomerId  String?          @unique  // Pour Stripe
  stripeSubscriptionId String?       // ID de l'abonnement Stripe actif

  // Flags de test
  isBetaTester      Boolean   @default(false)  // Accès aux features beta
  isAlphaTester     Boolean   @default(false)  // Accès aux features alpha (dev)

  // Limites et quotas (calculés dynamiquement selon le tier, mais overridable)
  storageUsedMb     Int       @default(0)
  maxStorageMb      Int       @default(500)    // Override possible par admin
  demosThisMonth    Int       @default(0)
  demosResetAt      DateTime  @default(now())  // Reset mensuel

  // Préférences
  preferredMaps String[]  @default([])

  // Rôle et rang du joueur (pour le coaching contextuel)
  role          PlayerRole?  // Rôle principal du joueur
  rank          CS2Rank?     // Rang actuel
  targetRank    CS2Rank?     // Rang cible pour la comparaison

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  demos              Demo[]
  sessions           Session[]
  stats              UserStats?
  featurePreferences UserFeaturePreferences?
  featureOverrides   UserFeatureOverride[]

  // Relations équipe (préparé pour le futur)
  teamMemberships TeamMember[]
  ownedTeams      Team[]       @relation("TeamOwner")

  @@index([steamId])
  @@index([email])
  @@index([systemRole])
  @@index([subscriptionTier])
}

// Rôle système (permissions plateforme)
enum SystemRole {
  USER           // Utilisateur standard
  ADMIN          // Administrateur plateforme
}

// Niveau d'abonnement
enum SubscriptionTier {
  FREE           // Gratuit, limité
  STARTER        // Starter, fonctionnalités essentielles
  PRO            // Pro, fonctionnalités complètes
  TEAM           // Plan équipe (attribué via Team)
  ENTERPRISE     // Sur mesure
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime

  @@index([userId])
}

// ============================================
// DEMOS ET ANALYSES
// ============================================

model Demo {
  id            String     @id @default(cuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Informations fichier
  filename      String
  originalName  String
  fileSizeMb    Float
  checksum      String     @unique  // MD5 pour éviter doublons

  // Informations partie
  mapName       String
  gameMode      String     @default("competitive")  // competitive, wingman, premier
  matchDate     DateTime
  duration      Int        // Durée en secondes

  // Résultat
  scoreTeam1    Int
  scoreTeam2    Int
  playerTeam    Int        // 1 ou 2
  matchResult   MatchResult

  // Status traitement
  status        DemoStatus @default(PENDING)
  statusMessage String?
  processingStartedAt DateTime?
  processingCompletedAt DateTime?

  // Stockage
  localPath     String?
  isArchived    Boolean    @default(false)
  archivedAt    DateTime?

  // Métadonnées extraites (JSONB)
  metadata      Json?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  analysis      Analysis?
  playerStats   DemoPlayerStats[]
  rounds        Round[]

  @@index([userId, matchDate(sort: Desc)])
  @@index([status])
  @@index([mapName])
  @@index([checksum])
}

enum DemoStatus {
  PENDING
  QUEUED
  PROCESSING
  ANALYZING
  COMPLETED
  FAILED
}

enum MatchResult {
  WIN
  LOSS
  TIE
}

// Rôles de joueur CS2
enum PlayerRole {
  ENTRY      // Entry fragger
  AWPER      // Sniper
  LURKER     // Lurk
  SUPPORT    // Support/Flash
  IGL        // In-game leader
  RIFLER     // Rifler polyvalent (défaut)
}

// Rangs CS2
enum CS2Rank {
  SILVER
  GOLD_NOVA
  MASTER_GUARDIAN
  LEGENDARY_EAGLE
  SUPREME
  GLOBAL
  // Premier ranks (ELO)
  PREMIER_0_5000
  PREMIER_5000_10000
  PREMIER_10000_15000
  PREMIER_15000_20000
  PREMIER_20000_PLUS
}

// Stats du joueur principal dans la démo
model DemoPlayerStats {
  id            String   @id @default(cuid())
  demoId        String
  demo          Demo     @relation(fields: [demoId], references: [id], onDelete: Cascade)

  steamId       String
  playerName    String
  isMainPlayer  Boolean  @default(false)  // Le joueur qui a uploadé
  team          Int      // 1 ou 2

  // Stats de base
  kills         Int
  deaths        Int
  assists       Int
  headshots     Int
  headshotPercentage Float

  // Stats avancées
  adr           Float    // Average Damage per Round
  kast          Float    // Kill/Assist/Survive/Trade percentage
  rating        Float    // HLTV 2.0 Rating

  // Détails par arme (JSONB)
  weaponStats   Json     // { "ak47": { kills: 10, hs: 5 }, ... }

  // Impact
  entryKills    Int      @default(0)
  entryDeaths   Int      @default(0)
  clutchesWon   Int      @default(0)
  clutchesLost  Int      @default(0)

  // Utilitaires
  flashAssists  Int      @default(0)
  enemiesFlashed Int     @default(0)
  utilityDamage Int      @default(0)

  createdAt     DateTime @default(now())

  @@unique([demoId, steamId])
  @@index([demoId])
  @@index([isMainPlayer])
}

model Round {
  id            String   @id @default(cuid())
  demoId        String
  demo          Demo     @relation(fields: [demoId], references: [id], onDelete: Cascade)

  roundNumber   Int
  winnerTeam    Int      // 1 ou 2
  winReason     String   // "bomb_exploded", "bomb_defused", "elimination", "time"

  // Économie au début du round
  team1Money    Int
  team2Money    Int
  team1Equipment Int
  team2Equipment Int

  // Événements clés (JSONB)
  events        Json     // Array d'événements avec timestamps

  // Positions clés (JSONB, échantillonné)
  positions     Json?    // Positions des joueurs à intervalles réguliers

  duration      Int      // Durée du round en secondes

  @@unique([demoId, roundNumber])
  @@index([demoId])
}

// ============================================
// ANALYSE DÉTAILLÉE
// ============================================

model Analysis {
  id            String   @id @default(cuid())
  demoId        String   @unique
  demo          Demo     @relation(fields: [demoId], references: [id], onDelete: Cascade)

  // Scores globaux (0-100)
  overallScore  Float
  aimScore      Float
  positioningScore Float
  utilityScore  Float
  economyScore  Float
  timingScore   Float
  decisionScore Float

  // Analyse aim détaillée (JSONB)
  aimAnalysis   Json
  // {
  //   crosshairPlacement: { score: 75, headLevelTime: 0.82 },
  //   reactionTime: { average: 245, best: 180 },
  //   accuracy: { overall: 0.32, headshot: 0.48 },
  //   sprayControl: { score: 68, transferSpeed: 0.4 },
  //   firstBulletAccuracy: 0.41
  // }

  // Analyse positionnement (JSONB)
  positioningAnalysis Json
  // {
  //   mapControl: { score: 72, avgAreaControlled: 0.35 },
  //   rotationSpeed: { average: 4.2, optimal: 3.5 },
  //   deathPositions: [{ x, y, count, isBadPosition }],
  //   commonMistakes: ["wide_peek", "exposed_angle"]
  // }

  // Analyse utilité (JSONB)
  utilityAnalysis Json
  // {
  //   flashEfficiency: { thrown: 12, enemiesFlashed: 8, effectiveness: 0.67 },
  //   smokeUsage: { thrown: 8, usedForExecute: 5 },
  //   molotovDamage: { thrown: 4, totalDamage: 89 },
  //   heUsage: { thrown: 6, totalDamage: 145 }
  // }

  // Analyse économie (JSONB)
  economyAnalysis Json
  // {
  //   buyDecisions: { correct: 18, incorrect: 4, score: 82 },
  //   saveRounds: { appropriate: 5, inappropriate: 1 },
  //   impactOnTeam: { positiveRounds: 12, negativeRounds: 3 },
  //   avgMoneyAtDeath: 2400
  // }

  // Analyse timing (JSONB)
  timingAnalysis Json
  // {
  //   peekTiming: { score: 71, avgPrefire: false },
  //   tradeSpeed: { average: 2.1, successful: 0.78 },
  //   rotationTiming: { early: 3, onTime: 8, late: 2 }
  // }

  // Analyse décisions (JSONB)
  decisionAnalysis Json
  // {
  //   clutchPerformance: { attempts: 4, won: 2, score: 65 },
  //   retakeDecisions: { correct: 7, incorrect: 2 },
  //   aggressionLevel: "balanced", // passive, balanced, aggressive
  //   riskTaking: { calculated: 8, reckless: 2 }
  // }

  // Forces et faiblesses identifiées
  strengths     String[]
  weaknesses    String[]

  // Comparaison avec moyennes (par rank si disponible)
  comparisonData Json?

  // Rapport de coaching généré
  coachingReport Json
  // {
  //   priority: [{ area: "aim", issue: "crosshair_placement", severity: "high" }],
  //   recommendations: [{ ... }],
  //   exercises: [{ ... }],
  //   weeklyPlan: { ... }
  // }

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([demoId])
}

// ============================================
// STATISTIQUES AGRÉGÉES (CACHE)
// ============================================

model UserStats {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stats globales calculées
  totalDemos    Int      @default(0)
  totalMatches  Int      @default(0)
  totalRounds   Int      @default(0)
  totalKills    Int      @default(0)
  totalDeaths   Int      @default(0)
  totalAssists  Int      @default(0)

  // Moyennes
  avgRating     Float    @default(0)
  avgAdr        Float    @default(0)
  avgKast       Float    @default(0)
  avgHsPercent  Float    @default(0)

  // Win rate
  wins          Int      @default(0)
  losses        Int      @default(0)
  ties          Int      @default(0)
  winRate       Float    @default(0)

  // Par map (JSONB)
  mapStats      Json     @default("{}")
  // { "de_dust2": { played: 10, winRate: 0.6, avgRating: 1.1 }, ... }

  // Progression (JSONB)
  ratingHistory Json     @default("[]")
  // [{ date: "2024-01-15", rating: 1.05 }, ...]

  // Scores d'analyse moyens
  avgAimScore   Float    @default(0)
  avgPositioningScore Float @default(0)
  avgUtilityScore Float  @default(0)
  avgEconomyScore Float  @default(0)

  lastUpdated   DateTime @default(now())

  @@index([userId])
}

// ============================================
// ÉQUIPES (préparé pour évolution future)
// ============================================

model Team {
  id          String   @id @default(cuid())
  name        String
  tag         String   // Ex: "NaVi", "G2" (max 5 chars)
  avatarUrl   String?
  description String?

  // Propriétaire de l'équipe
  ownerId     String
  owner       User     @relation("TeamOwner", fields: [ownerId], references: [id])

  // Abonnement équipe
  subscriptionTier  SubscriptionTier @default(TEAM)
  subscriptionExpiresAt DateTime?
  stripeSubscriptionId String?

  // Limites
  maxMembers  Int      @default(7)

  // Membres
  members     TeamMember[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
}

model TeamMember {
  id        String   @id @default(cuid())

  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Rôle dans l'équipe
  teamRole  TeamRole @default(PLAYER)

  // Permissions spécifiques (override du rôle)
  canUploadDemos    Boolean @default(true)
  canViewAllDemos   Boolean @default(false)
  canManageMembers  Boolean @default(false)
  canEditSettings   Boolean @default(false)

  joinedAt  DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// Rôle dans une équipe
enum TeamRole {
  PLAYER     // Joueur standard
  COACH      // Coach - peut voir tous les joueurs
  ANALYST    // Analyste - lecture seule
  MANAGER    // Manager - gestion équipe
  OWNER      // Propriétaire - tous les droits
}

// ============================================
// CONFIGURATION SYSTÈME
// ============================================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique  // Ex: "coaching_features", "notification_settings"
  value     Json     // Configuration stockée en JSON

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ============================================
// PROGRESSION & COACHING ACTIONNABLE
// ============================================

// Objectifs de progression du joueur
model PlayerGoal {
  id            String   @id @default(cuid())
  userId        String

  // Objectif
  category      String   // aim, positioning, utility, etc.
  metric        String   // headshotPercentage, isolatedDeathRate, etc.
  description   String

  // Valeurs
  startValue    Float
  currentValue  Float
  targetValue   Float

  // Status
  status        GoalStatus @default(ACTIVE)
  progress      Float      @default(0) // 0-100%

  // Lien avec insight
  insightId     String?

  // Dates
  createdAt     DateTime @default(now())
  deadline      DateTime?
  completedAt   DateTime?

  // Relations - user relation via implicit many-to-many
  snapshots     ProgressSnapshot[]

  @@index([userId, status])
  @@index([category])
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  FAILED
  PAUSED
}

// Snapshots de progression (historique des métriques)
model ProgressSnapshot {
  id            String   @id @default(cuid())
  userId        String

  // Lien optionnel avec une démo
  demoId        String?

  // Lien optionnel avec un objectif
  goalId        String?
  goal          PlayerGoal? @relation(fields: [goalId], references: [id], onDelete: SetNull)

  // Métriques capturées (JSONB)
  metrics       Json
  // {
  //   aim: { headshotPercentage: 45, reactionTime: 250, ... },
  //   positioning: { isolatedDeathRate: 0.3, mapControlScore: 65, ... },
  //   utility: { flashEfficiency: 0.45, ... },
  //   ...
  // }

  // Scores
  overallScore  Float
  aimScore      Float
  positioningScore Float
  utilityScore  Float
  economyScore  Float
  timingScore   Float
  decisionScore Float

  // Contexte
  rank          CS2Rank?
  targetRank    CS2Rank?
  map           String?

  createdAt     DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([goalId])
}

// Exercices complétés par le joueur
model ExerciseCompletion {
  id            String   @id @default(cuid())
  userId        String

  // Exercice
  exerciseId    String   // ID de l'exercice (aim_botz, prefire_mirage, etc.)
  exerciseName  String
  exerciseType  String   // workshop_map, community_server, theory, etc.
  category      String   // aim, positioning, utility, etc.

  // Durée et résultat
  duration      Int      // minutes
  completed     Boolean  @default(true)

  // Performance (optionnel)
  performance   Json?    // { score: 80, kills: 150, hsRate: 70, ... }

  // Notes du joueur
  notes         String?

  // Lien avec objectif
  goalId        String?

  createdAt     DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([exerciseId])
  @@index([category])
}

// Sessions de coaching (rapports générés)
model CoachingSession {
  id            String   @id @default(cuid())
  userId        String
  demoId        String?

  // Type de session
  type          CoachingSessionType @default(DEMO_ANALYSIS)

  // Rapport complet (JSONB)
  report        Json
  // {
  //   executiveSummary: { ... },
  //   insights: [ ... ],
  //   rankComparison: { ... },
  //   actionPlan: { ... },
  //   ...
  // }

  // Résumé
  overallScore  Float
  mainStrength  String
  mainWeakness  String
  focusArea     String

  // Insights générés
  insightsCount Int      @default(0)
  criticalCount Int      @default(0)

  // Contexte
  playerRank    CS2Rank?
  targetRank    CS2Rank?
  playerRole    PlayerRole?
  map           String?

  createdAt     DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([demoId])
}

enum CoachingSessionType {
  DEMO_ANALYSIS      // Analyse d'une démo
  WEEKLY_REVIEW      // Revue hebdomadaire
  GOAL_CHECK         // Vérification d'objectif
  PROGRESS_REPORT    // Rapport de progression
}

// Plan d'entraînement actif
model TrainingPlan {
  id            String   @id @default(cuid())
  userId        String   @unique

  // Focus actuel
  primaryFocus  String
  secondaryFocus String?

  // Plan hebdomadaire (JSONB)
  weeklyPlan    Json
  // {
  //   monday: { focus: "aim", exercises: [...], duration: 30 },
  //   tuesday: { focus: "positioning", exercises: [...], duration: 30 },
  //   ...
  // }

  // Routine quotidienne (JSONB)
  dailyRoutine  Json
  // {
  //   warmup: [...],
  //   mainTraining: [...],
  //   cooldown: [...]
  // }

  // Objectifs de la semaine
  weeklyGoals   Json     @default("[]")

  // Status
  isActive      Boolean  @default(true)

  // Dates
  startDate     DateTime @default(now())
  endDate       DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

// ============================================
// FEATURE FLAGS & PRÉFÉRENCES
// ============================================

// Préférences de features d'un utilisateur
model UserFeaturePreferences {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Features explicitement désactivées par l'utilisateur
  disabledFeatures String[]  @default([])

  // Features explicitement activées (pour celles désactivées par défaut)
  enabledFeatures  String[]  @default([])

  // Configuration spécifique par feature (JSONB)
  featureConfigs   Json      @default("{}")
  // {
  //   "display.heatmaps": { showLabels: true, colorScheme: "default" },
  //   "coaching.weekly_plan": { daysPerWeek: 5, minutesPerDay: 30 }
  // }

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

// Override administrateur pour un utilisateur
model UserFeatureOverride {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Feature concernée
  featureId     String

  // Forcer l'activation ou la désactivation
  enabled       Boolean

  // Raison de l'override (pour l'admin)
  reason        String?

  // Date d'expiration de l'override (null = permanent)
  expiresAt     DateTime?

  // Qui a créé cet override
  createdBy     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, featureId])
  @@index([userId])
  @@index([featureId])
  @@index([expiresAt])
}

// Utilisation des features (pour les limites)
model FeatureUsage {
  id            String   @id @default(cuid())
  userId        String

  // Feature concernée
  featureId     String

  // Période de comptage
  periodStart   DateTime
  periodEnd     DateTime

  // Compteur d'utilisation
  count         Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, featureId, periodStart])
  @@index([userId, featureId])
  @@index([periodEnd])
}

// ============================================
// JOBS (géré par pg-boss, tables auto-créées)
// ============================================
// pg-boss crée automatiquement ses tables :
// - pgboss.job
// - pgboss.schedule
// - pgboss.version
// Pas besoin de les définir ici
